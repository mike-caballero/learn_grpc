worker_processes  auto;

error_log   runtime/nginx_error.log notice;
pid         runtime/nginx.pid;

events {}

http {
    upstream backend {
        server localhost:8000;
    }

    server {
        listen 8080;
        listen [::]:8080;
        http2 on;

        location /helloworld.Greeter/SayHello {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'grpc-timeout, content-type, X-User-Agent, X-Grpc-Web';

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Length' '0';
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                return 204;
            }

            grpc_pass grpc://backend;
            error_page 502 = /error502grpc;
        }

        location = /error502grpc {
            internal;
            default_type application/grpc;
            add_header grpc-status 14;
            add_header content-length 0;
            return 204;
        }
    }
}